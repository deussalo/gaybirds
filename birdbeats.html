<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>GAY BIRDS - BIRD BEATS</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            @font-face {
                font-family: "KidPixiesRegular";
                src: url("./font/kidpixies-font/KidpixiesRegular-p0Z1.ttf")
                    format("truetype");
            }

            body {
                background: #c0c0c0;
                font-family:
                    "KidPixiesRegular", "Comic Sans MS", cursive, sans-serif;
                overflow: hidden;
                image-rendering: pixelated;
                width: 100vw;
                height: 100vh;
                display: flex;
                flex-direction: column;
            }

            #header {
                background:
                    repeating-linear-gradient(
                        90deg,
                        transparent,
                        transparent 10px,
                        rgba(0, 0, 0, 0.05) 10px,
                        rgba(0, 0, 0, 0.05) 11px
                    ),
                    linear-gradient(180deg, #ffffff 0%, #c0c0c0 100%);
                border-bottom: 3px solid #000;
                padding: 12px;
                text-align: center;
                font-size: 24px;
                font-weight: bold;
                letter-spacing: 3px;
                box-shadow:
                    inset 1px 1px 0 #fff,
                    inset -1px -1px 0 #808080;
            }

            #main-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                padding: 20px;
                gap: 20px;
                overflow-y: auto;
                background:
                    radial-gradient(
                        circle at 20% 20%,
                        rgba(147, 112, 219, 0.1),
                        transparent 30%
                    ),
                    radial-gradient(
                        circle at 80% 80%,
                        rgba(255, 165, 0, 0.1),
                        transparent 30%
                    ),
                    repeating-linear-gradient(
                        45deg,
                        #b0b0b0 0,
                        #b0b0b0 1px,
                        transparent 0,
                        transparent 50%
                    ),
                    repeating-linear-gradient(
                        -45deg,
                        #b0b0b0 0,
                        #b0b0b0 1px,
                        transparent 0,
                        transparent 50%
                    ),
                    #c0c0c0;
                background-size:
                    100% 100%,
                    100% 100%,
                    4px 4px,
                    4px 4px,
                    100% 100%;
            }

            .section {
                background: #d0d0d0;
                border: 3px solid;
                border-color: #ffffff #000000 #000000 #ffffff;
                padding: 15px;
                box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
            }

            .section-title {
                font-size: 16px;
                margin-bottom: 12px;
                padding: 4px 8px;
                background: linear-gradient(180deg, #ffffff 0%, #c0c0c0 100%);
                border: 2px solid #000;
                text-align: center;
            }

            #pads-container {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 12px;
                max-width: 1200px;
                margin: 0 auto;
            }

            @media (max-width: 900px) {
                #pads-container {
                    grid-template-columns: repeat(3, 1fr);
                }
            }

            .drum-pad {
                aspect-ratio: 1;
                background:
                    radial-gradient(
                        circle at 10% 10%,
                        rgba(255, 255, 255, 0.8),
                        transparent
                    ),
                    #ffffff;
                border: 4px solid;
                border-color: #ffffff #000000 #000000 #ffffff;
                cursor: pointer;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                font-weight: bold;
                transition: all 0.05s;
                position: relative;
                overflow: hidden;
            }

            .drum-pad::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 0, 0, 0.02) 2px,
                    rgba(0, 0, 0, 0.02) 4px
                );
                pointer-events: none;
            }

            .drum-pad:hover {
                background:
                    radial-gradient(
                        circle at 10% 10%,
                        rgba(255, 255, 255, 0.8),
                        transparent
                    ),
                    #efefef;
            }

            .drum-pad:active,
            .drum-pad.playing {
                border-color: #000000 #ffffff #ffffff #000000;
                background: #ffff00;
                transform: scale(0.95);
            }

            .drum-pad-icon {
                font-size: 32px;
                margin-bottom: 4px;
            }

            .drum-pad-label {
                font-size: 10px;
                text-align: center;
            }

            #sequencer {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .sequencer-row {
                display: flex;
                gap: 4px;
                align-items: center;
            }

            .sequencer-label {
                width: 100px;
                font-size: 11px;
                font-weight: bold;
                padding: 4px;
                background: #a0a0a0;
                border: 2px solid;
                border-color: #ffffff #000000 #000000 #ffffff;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
            }

            .step {
                flex: 1;
                aspect-ratio: 1;
                max-width: 40px;
                background: #909090;
                border: 2px solid;
                border-color: #000000 #ffffff #ffffff #000000;
                cursor: pointer;
                transition: all 0.05s;
            }

            .step.downbeat {
                background: #606060;
            }

            .step:hover {
                background: #a0a0a0;
            }

            .step.downbeat:hover {
                background: #707070;
            }

            .step.active {
                background: #00ff00;
                border-color: #ffffff #000000 #000000 #ffffff;
                box-shadow: inset 0 0 0 2px #00cc00;
            }

            .step.current {
                box-shadow: 0 0 0 3px #ff00ff;
            }

            .step.active.current {
                box-shadow:
                    0 0 0 3px #ff00ff,
                    inset 0 0 0 2px #00cc00;
            }

            #controls {
                display: flex;
                gap: 12px;
                align-items: center;
                justify-content: center;
                flex-wrap: wrap;
            }

            .control-btn {
                background:
                    radial-gradient(
                        circle at 10% 10%,
                        rgba(255, 255, 255, 0.8),
                        transparent
                    ),
                    #ffffff;
                border: 3px solid;
                border-color: #ffffff #000000 #000000 #ffffff;
                padding: 12px 24px;
                font-family: "KidPixiesRegular", "Comic Sans MS", cursive;
                font-size: 14px;
                font-weight: bold;
                cursor: pointer;
                min-width: 100px;
            }

            .control-btn:active {
                border-color: #000000 #ffffff #ffffff #000000;
                transform: translateY(2px);
            }

            .control-btn.active {
                background: #ff00ff;
                border-color: #000000 #ffffff #ffffff #000000;
            }

            .tempo-control {
                display: flex;
                align-items: center;
                gap: 8px;
                background: #ffffff;
                border: 3px solid;
                border-color: #000000 #ffffff #ffffff #000000;
                padding: 8px 12px;
            }

            .tempo-control label {
                font-size: 12px;
                font-weight: bold;
            }

            .tempo-control input {
                width: 80px;
                font-family: "KidPixiesRegular", "Comic Sans MS", cursive;
                font-size: 12px;
                padding: 4px;
                border: 2px solid #000;
            }

            #status-bar {
                background: #c0c0c0;
                border-top: 2px solid #000;
                padding: 6px 12px;
                font-size: 11px;
                display: flex;
                justify-content: space-between;
                box-shadow: inset 1px 1px 0 #808080;
            }

            .visual-indicator {
                width: 200px;
                height: 40px;
                background: #000;
                border: 3px solid;
                border-color: #000000 #ffffff #ffffff #000000;
                position: relative;
                overflow: hidden;
            }

            .waveform-bar {
                position: absolute;
                bottom: 0;
                width: 8px;
                background: linear-gradient(180deg, #00ff00 0%, #00cc00 100%);
                transition: height 0.05s;
            }

            #synth-panel {
                display: none;
            }

            #synth-panel.active {
                display: block;
            }

            .synth-controls {
                display: flex;
                gap: 12px;
                flex-wrap: wrap;
                align-items: center;
                justify-content: center;
                margin-top: 12px;
            }

            .synth-control-group {
                display: flex;
                flex-direction: column;
                gap: 6px;
                background: #ffffff;
                border: 3px solid;
                border-color: #000000 #ffffff #ffffff #000000;
                padding: 8px 12px;
            }

            .synth-control-group label {
                font-size: 10px;
                font-weight: bold;
                text-align: center;
            }

            .synth-btn {
                background:
                    radial-gradient(
                        circle at 10% 10%,
                        rgba(255, 255, 255, 0.8),
                        transparent
                    ),
                    #ffffff;
                border: 3px solid;
                border-color: #ffffff #000000 #000000 #ffffff;
                padding: 8px 16px;
                font-family: "KidPixiesRegular", "Comic Sans MS", cursive;
                font-size: 12px;
                font-weight: bold;
                cursor: pointer;
                min-width: 80px;
            }

            .synth-btn:active {
                border-color: #000000 #ffffff #ffffff #000000;
                transform: translateY(2px);
            }

            .synth-btn.active {
                background: #ff0000 !important;
                color: #ffffff;
                border-color: #000000 #ff6666 #ff6666 #000000;
            }

            .angry-knob-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 6px;
                background: #ffffff;
                border: 3px solid;
                border-color: #000000 #ffffff #ffffff #000000;
                padding: 12px;
                user-select: none;
            }

            .angry-knob-label {
                font-size: 10px;
                font-weight: bold;
                text-align: center;
            }

            .angry-knob {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                border: 3px solid #000;
                position: relative;
                cursor: grab;
                background: radial-gradient(circle at 30% 30%, #ffffff, #808080);
                box-shadow: inset -2px -2px 4px rgba(0,0,0,0.3), inset 2px 2px 4px rgba(255,255,255,0.5);
            }

            .angry-knob:active {
                cursor: grabbing;
            }

            .angry-knob-indicator {
                position: absolute;
                top: 5px;
                left: 50%;
                transform: translateX(-50%);
                width: 4px;
                height: 15px;
                background: #000;
                border-radius: 2px;
            }

            .angry-knob-value {
                font-size: 12px;
                font-weight: bold;
                text-align: center;
                min-width: 40px;
            }

            .keyboard-display {
                display: flex;
                flex-direction: column;
                gap: 8px;
                align-items: center;
                margin-top: 12px;
            }

            .keyboard-row {
                display: flex;
                gap: 4px;
                justify-content: center;
            }

            .keyboard-row-label {
                font-size: 10px;
                text-align: center;
                margin-bottom: 4px;
                font-weight: bold;
            }

            .piano-key {
                width: 40px;
                height: 120px;
                background: #ffffff;
                border: 3px solid;
                border-color: #ffffff #000000 #000000 #ffffff;
                font-size: 10px;
                font-weight: bold;
                display: flex;
                align-items: flex-end;
                justify-content: center;
                padding-bottom: 8px;
                cursor: pointer;
                position: relative;
            }

            .piano-key:active,
            .piano-key.playing {
                background: #ffff00;
                border-color: #000000 #ffffff #ffffff #000000;
            }

            .piano-key.black {
                width: 30px;
                height: 80px;
                background: #303030;
                border-color: #000000 #505050 #505050 #000000;
                color: #ffffff;
                margin: 0 -15px;
                z-index: 1;
            }

            .piano-key.black:active,
            .piano-key.black.playing {
                background: #ffaa00;
            }
        </style>
    </head>
    <body>
        <div id="header">üê¶ GAY BIRDS BIRD BEATS üê¶</div>

        <div id="main-container">
            <div class="section">
                <div class="section-title">üéπ BIRD PADS üéπ</div>
                <div id="pads-container"></div>
            </div>

            <div class="section">
                <div class="section-title">üéµ SEQUENCER (16 STEPS) üéµ</div>
                <div id="sequencer"></div>
            </div>

            <div class="section">
                <div class="section-title">‚öôÔ∏è CONTROLS ‚öôÔ∏è</div>
                <div id="controls">
                    <button class="control-btn" id="play-btn">‚ñ∂ PLAY</button>
                    <button class="control-btn" id="stop-btn">‚èπ STOP</button>
                    <button class="control-btn" id="clear-btn">üóë CLEAR</button>
                    <button class="control-btn" id="random-btn">
                        üé≤ RANDOM
                    </button>
                    <button class="control-btn" id="newbirds-btn">
                        üê¶ NEW BIRDS
                    </button>
                    <button class="control-btn" id="keyboard-btn">
                        üéπ KEYBOARD
                    </button>
                    <div class="tempo-control">
                        <label>BPM:</label>
                        <input
                            type="number"
                            id="tempo-input"
                            value="80"
                            min="60"
                            max="200"
                            step="5"
                        />
                    </div>
                    <div class="visual-indicator" id="visualizer"></div>
                </div>
            </div>

            <div class="section" id="synth-panel">
                <div class="section-title">üéπ BIRD SYNTHESIZER üéπ</div>
                <div class="synth-controls">
                    <button class="synth-btn" id="octave-down">‚¨á OCTAVE</button>
                    <div class="synth-control-group">
                        <label>OCTAVE</label>
                        <div
                            id="octave-display"
                            style="
                                font-size: 18px;
                                text-align: center;
                                font-weight: bold;
                                min-width: 30px;
                            "
                        >
                            0
                        </div>
                    </div>
                    <button class="synth-btn" id="octave-up">‚¨Ü OCTAVE</button>
                    <button class="synth-btn" id="random-synth">
                        üé≤ RANDOM SYNTH
                    </button>
                    <div class="angry-knob-container">
                        <div class="angry-knob-label">üò° ANGRY BIRD</div>
                        <div class="angry-knob" id="angry-knob">
                            <div class="angry-knob-indicator"></div>
                        </div>
                        <div class="angry-knob-value" id="angry-knob-value">0</div>
                    </div>
                </div>
                <div class="keyboard-display">
                    <!-- Upper octave - QWERTY row (C5-G6) -->
                    <div>
                        <div class="keyboard-row-label">UPPER OCTAVE (C5-G6) - QWERTY ROW</div>
                        <div class="keyboard-row">
                            <div class="piano-key" data-note="C5" data-key="q">Q</div>
                            <div class="piano-key black" data-note="C#5" data-key="2">2</div>
                            <div class="piano-key" data-note="D5" data-key="w">W</div>
                            <div class="piano-key black" data-note="D#5" data-key="3">3</div>
                            <div class="piano-key" data-note="E5" data-key="e">E</div>
                            <div class="piano-key" data-note="F5" data-key="r">R</div>
                            <div class="piano-key black" data-note="F#5" data-key="5">5</div>
                            <div class="piano-key" data-note="G5" data-key="t">T</div>
                            <div class="piano-key black" data-note="G#5" data-key="6">6</div>
                            <div class="piano-key" data-note="A5" data-key="y">Y</div>
                            <div class="piano-key black" data-note="A#5" data-key="7">7</div>
                            <div class="piano-key" data-note="B5" data-key="u">U</div>
                            <div class="piano-key" data-note="C6" data-key="i">I</div>
                            <div class="piano-key black" data-note="C#6" data-key="9">9</div>
                            <div class="piano-key" data-note="D6" data-key="o">O</div>
                            <div class="piano-key black" data-note="D#6" data-key="0">0</div>
                            <div class="piano-key" data-note="E6" data-key="p">P</div>
                            <div class="piano-key" data-note="F6" data-key="[">[</div>
                            <div class="piano-key black" data-note="F#6" data-key="-">-</div>
                            <div class="piano-key" data-note="G6" data-key="]">]</div>
                            <div class="piano-key black" data-note="G#6" data-key="=">=</div>
                        </div>
                    </div>

                    <!-- Lower octave - ZXCVBNM row (C4-E5) -->
                    <div>
                        <div class="keyboard-row-label">LOWER OCTAVE (C4-E5) - ZXCVBNM ROW</div>
                        <div class="keyboard-row">
                            <div class="piano-key" data-note="C4" data-key="z">Z</div>
                            <div class="piano-key black" data-note="C#4" data-key="s">S</div>
                            <div class="piano-key" data-note="D4" data-key="x">X</div>
                            <div class="piano-key black" data-note="D#4" data-key="d">D</div>
                            <div class="piano-key" data-note="E4" data-key="c">C</div>
                            <div class="piano-key" data-note="F4" data-key="v">V</div>
                            <div class="piano-key black" data-note="F#4" data-key="g">G</div>
                            <div class="piano-key" data-note="G4" data-key="b">B</div>
                            <div class="piano-key black" data-note="G#4" data-key="h">H</div>
                            <div class="piano-key" data-note="A4" data-key="n">N</div>
                            <div class="piano-key black" data-note="A#4" data-key="j">J</div>
                            <div class="piano-key" data-note="B4" data-key="m">M</div>
                            <div class="piano-key" data-note="C5" data-key=",">,</div>
                            <div class="piano-key black" data-note="C#5" data-key="l">L</div>
                            <div class="piano-key" data-note="D5" data-key=".">.</div>
                            <div class="piano-key black" data-note="D#5" data-key=";">;</div>
                            <div class="piano-key" data-note="E5" data-key="/">/</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="status-bar">
            <span id="status-text"
                >Ready to jam! Click pads or use keyboard (QWER/ASDF/ZXCV)</span
            >
            <span id="step-counter">Step: 0/16</span>
        </div>

        <script>
            const soundSlots = [
                "slot1",
                "slot2",
                "slot3",
                "slot4",
                "slot5",
                "slot6",
                "slot7",
                "slot8",
                "slot9",
                "slot10",
                "slot11",
                "slot12",
            ];
            const keys = [
                "q",
                "w",
                "e",
                "r",
                "a",
                "s",
                "d",
                "f",
                "z",
                "x",
                "c",
                "v",
            ];

            const birdPool = [
                { name: "CHIRP", emoji: "üê¶" },
                { name: "TWEET", emoji: "ü¶ú" },
                { name: "PEEP", emoji: "üê•" },
                { name: "WARBLE", emoji: "ü¶¢" },
                { name: "CLUCK", emoji: "üêî" },
                { name: "ROOSTER", emoji: "üêì" },
                { name: "CROW", emoji: "ü¶Ö" },
                { name: "RAVEN", emoji: "üê¶‚Äç‚¨õ" },
                { name: "KOOKABUR", emoji: "ü¶ú" },
                { name: "HOOT", emoji: "ü¶â" },
                { name: "GOOSE", emoji: "ü¶Ü" },
                { name: "PIGEON", emoji: "üïäÔ∏è" },
                { name: "SEAGULL", emoji: "ü¶Ü" },
                { name: "PARROT", emoji: "ü¶ú" },
                { name: "TOUCAN", emoji: "ü¶ú" },
                { name: "FINCH", emoji: "üê¶" },
                { name: "ROBIN", emoji: "üê¶" },
                { name: "BLUEJAY", emoji: "üê¶" },
                { name: "CARDINAL", emoji: "üê¶" },
                { name: "SPARROW", emoji: "üê¶" },
                { name: "CANARY", emoji: "üê¶" },
                { name: "MOCKBIRD", emoji: "üê¶" },
                { name: "DOVE", emoji: "üïäÔ∏è" },
                { name: "PENGUIN", emoji: "üêß" },
                { name: "FLAMINGO", emoji: "ü¶©" },
                { name: "PEACOCK", emoji: "ü¶ö" },
                { name: "OSTRICH", emoji: "ü™∂" },
                { name: "EMU", emoji: "ü™∂" },
                { name: "QUAIL", emoji: "üê¶" },
                { name: "TURKEY", emoji: "ü¶É" },
                { name: "DUCK", emoji: "ü¶Ü" },
                { name: "SWAN", emoji: "ü¶¢" },
                { name: "PELICAN", emoji: "üê¶" },
                { name: "STORK", emoji: "üê¶" },
                { name: "EAGLE", emoji: "ü¶Ö" },
                { name: "HAWK", emoji: "ü¶Ö" },
                { name: "FALCON", emoji: "ü¶Ö" },
                { name: "VULTURE", emoji: "ü¶Ö" },
                { name: "MAGPIE", emoji: "üê¶‚Äç‚¨õ" },
                { name: "JACKDAW", emoji: "üê¶‚Äç‚¨õ" },
                { name: "GRACKLE", emoji: "üê¶‚Äç‚¨õ" },
                { name: "STARLING", emoji: "üê¶" },
                { name: "WREN", emoji: "üê¶" },
                { name: "THRUSH", emoji: "üê¶" },
                { name: "LARK", emoji: "üê¶" },
                { name: "NIGHTGALE", emoji: "üê¶" },
            ];

            let sounds = {
                slot1: {
                    name: "KICK",
                    key: "q",
                    color: "#ffb3ba",
                    emoji: "ü•Å",
                },
                slot2: {
                    name: "SNARE",
                    key: "w",
                    color: "#bae1ff",
                    emoji: "ü•Å",
                },
                slot3: {
                    name: "HIHAT",
                    key: "e",
                    color: "#e0bbff",
                    emoji: "ü•Å",
                },
                slot4: {
                    name: "CYMBAL",
                    key: "r",
                    color: "#c9ffd5",
                    emoji: "ü•Å",
                },
                slot5: {
                    name: "CLUCK",
                    key: "a",
                    color: "#ffdfba",
                    emoji: "üêî",
                },
                slot6: {
                    name: "ROOSTER",
                    key: "s",
                    color: "#ffc9de",
                    emoji: "üêì",
                },
                slot7: {
                    name: "CROW",
                    key: "d",
                    color: "#ffffba",
                    emoji: "ü¶Ö",
                },
                slot8: {
                    name: "RAVEN",
                    key: "f",
                    color: "#b0b0b0",
                    emoji: "üê¶‚Äç‚¨õ",
                },
                slot9: {
                    name: "KOOKABUR",
                    key: "z",
                    color: "#baffc9",
                    emoji: "ü¶ú",
                },
                slot10: {
                    name: "HOOT",
                    key: "x",
                    color: "#d4a5a5",
                    emoji: "ü¶â",
                },
                slot11: {
                    name: "GOOSE",
                    key: "c",
                    color: "#ffd4a3",
                    emoji: "ü¶Ü",
                },
                slot12: {
                    name: "PIGEON",
                    key: "v",
                    color: "#c9c9c9",
                    emoji: "üïäÔ∏è",
                },
            };

            const audioContext = new (
                window.AudioContext || window.webkitAudioContext
            )();
            let isPlaying = false;
            let currentStep = 0;
            let bpm = 120;
            let intervalId = null;
            const steps = 16;
            let soundParams = {};
            let drumParams = {
                kick: { startFreq: 150, endFreq: 50, decay: 0.4 },
                snare: { toneFreq: 300, noiseCutoff: 1000, decay: 0.15 },
                hihat: { cutoffFreq: 8000, decay: 0.08 },
                cymbal: { centerFreq: 5000, decay: 2.0, lfoRate: 3 }
            };
            let isKeyboardMode = false;
            let currentOctave = 0;
            let activeNotes = new Map();
            let angryBirdAmount = 0; // 0-400
            let reverbNode = null;
            let isDraggingKnob = false;

            // Synth parameters (designed to be extended with ADSR later)
            let synthParams = {
                waveform: "sine",
                brightness: 0.15,
                harmonics: 0.2,
                // Placeholder for future ADSR
                attack: 0.01,
                decay: 0.1,
                sustain: 0.8,
                release: 0.3,
            };

            // Note to frequency mapping - FL Studio layout
            const noteFrequencies = {
                // Lower octave (Z-M row) - C4 to B4
                C4: 261.63,
                "C#4": 277.18,
                "D4": 293.66,
                "D#4": 311.13,
                E4: 329.63,
                F4: 349.23,
                "F#4": 369.99,
                G4: 392.00,
                "G#4": 415.30,
                A4: 440.00,
                "A#4": 466.16,
                B4: 493.88,

                // Upper octave (Q-U row) - C5 to B5
                C5: 523.25,
                "C#5": 554.37,
                D5: 587.33,
                "D#5": 622.25,
                E5: 659.25,
                F5: 698.46,
                "F#5": 739.99,
                G5: 783.99,
                "G#5": 830.61,
                A5: 880.00,
                "A#5": 932.33,
                B5: 987.77,

                // Extended high notes (I-] keys)
                C6: 1046.50,
                "C#6": 1108.73,
                D6: 1174.66,
                "D#6": 1244.51,
                E6: 1318.51,
                F6: 1396.91,
                "F#6": 1479.98,
                G6: 1567.98,
                "G#6": 1661.22,
            };

            // Randomize drum parameters slightly
            function randomizeDrumParams() {
                drumParams = {
                    kick: {
                        startFreq: 120 + Math.random() * 80,  // 120-200 Hz
                        endFreq: 40 + Math.random() * 30,     // 40-70 Hz
                        decay: 0.3 + Math.random() * 0.3      // 0.3-0.6s
                    },
                    snare: {
                        toneFreq: 200 + Math.random() * 300,  // 200-500 Hz
                        noiseCutoff: 800 + Math.random() * 1200, // 800-2000 Hz
                        decay: 0.1 + Math.random() * 0.15     // 0.1-0.25s
                    },
                    hihat: {
                        cutoffFreq: 6000 + Math.random() * 4000, // 6000-10000 Hz
                        decay: 0.05 + Math.random() * 0.08    // 0.05-0.13s
                    },
                    cymbal: {
                        centerFreq: 4000 + Math.random() * 3000, // 4000-7000 Hz
                        decay: 1.5 + Math.random() * 1.0,     // 1.5-2.5s
                        lfoRate: 2 + Math.random() * 3        // 2-5 Hz
                    }
                };
            }

            // Generate random sound parameters for a bird
            function generateRandomSoundParams() {
                const freq = 50 + Math.random() * 2000; // 150Hz to 2650Hz
                const duration = 0.08 + Math.random() * 0.5; // 0.08s to 0.58s
                const modFreq = Math.random() * 20; // 0 to 20Hz
                const types = ["sine", "square", "sawtooth", "triangle"];
                const type = types[Math.floor(Math.random() * types.length)];
                const modDepth = Math.random() * 200;

                const params = {
                    freq: freq,
                    duration: duration,
                    modFreq: modFreq,
                    type: type,
                    modDepth: modDepth,
                    noisy: Math.random() < 0.2,
                    harsh: Math.random() < 0.15 && freq < 500,
                    sweep: Math.random() < 0.1,
                    laugh: Math.random() < 0.05,
                    honk: Math.random() < 0.1,
                };

                return params;
            }

            // Initialize sound parameters
            function initializeSoundParams() {
                soundSlots.forEach((slot) => {
                    // First 4 slots are drums (fixed synthesis), rest are random birds
                    if (!['slot1', 'slot2', 'slot3', 'slot4'].includes(slot)) {
                        soundParams[slot] = generateRandomSoundParams();
                    }
                });
            }

            // Render pads
            function renderPads() {
                const padsContainer = document.getElementById("pads-container");
                padsContainer.innerHTML = "";

                soundSlots.forEach((slot, index) => {
                    const sound = sounds[slot];
                    const pad = document.createElement("div");
                    pad.className = "drum-pad";
                    pad.dataset.sound = slot;
                    pad.dataset.key = sound.key;

                    const icon = document.createElement("div");
                    icon.className = "drum-pad-icon";
                    icon.textContent = sound.emoji;

                    const label = document.createElement("div");
                    label.className = "drum-pad-label";
                    label.innerHTML = `${sound.name}<br>(${sound.key.toUpperCase()})`;

                    pad.appendChild(icon);
                    pad.appendChild(label);

                    pad.addEventListener("click", () => {
                        playSound(slot);
                    });

                    padsContainer.appendChild(pad);
                });
            }

            // Generate new random birds (slots 5-12 only, keep drums in 1-4)
            function generateNewBirds() {
                // Randomize drum sounds slightly
                randomizeDrumParams();

                // Shuffle bird pool and pick 8 birds for slots 5-12
                const shuffled = [...birdPool].sort(() => Math.random() - 0.5);
                const selected = shuffled.slice(0, 8);

                const birdColors = [
                    "#ffdfba",
                    "#ffc9de",
                    "#ffffba",
                    "#b0b0b0",
                    "#baffc9",
                    "#d4a5a5",
                    "#ffd4a3",
                    "#c9c9c9",
                ];

                // Only update slots 5-12 (bird sounds)
                soundSlots.forEach((slot, index) => {
                    if (index >= 4) {
                        // Slots 5-12 are bird sounds
                        const birdIndex = index - 4;
                        sounds[slot] = {
                            name: selected[birdIndex].name,
                            key: keys[index],
                            color: birdColors[birdIndex],
                            emoji: selected[birdIndex].emoji,
                        };
                        soundParams[slot] = generateRandomSoundParams();
                    }
                    // Slots 1-4 stay as drums (KICK, SNARE, HIHAT, CYMBAL)
                    // Keep existing sequencer pattern
                });

                renderPads();
                renderSequencer();

                // Update status
                document.getElementById("status-text").textContent =
                    "ü•Åüê¶ New sounds loaded! Ready to jam!";
                setTimeout(() => {
                    document.getElementById("status-text").textContent =
                        "Ready to jam! Click pads or use keyboard (QWER/ASDF/ZXCV)";
                }, 2000);
            }

            // Initialize sequencer grid
            const sequencer = document.getElementById("sequencer");
            const sequencerData = {};

            function renderSequencer() {
                sequencer.innerHTML = "";

                // Reinitialize sequencer data if needed
                Object.keys(sounds).forEach((sound) => {
                    if (!sequencerData[sound]) {
                        sequencerData[sound] = new Array(steps).fill(false);
                    }

                    const row = document.createElement("div");
                    row.className = "sequencer-row";

                    const label = document.createElement("div");
                    label.className = "sequencer-label";
                    label.textContent = sounds[sound].name;
                    row.appendChild(label);

                    for (let i = 0; i < steps; i++) {
                        const step = document.createElement("div");
                        step.className = "step";
                        step.dataset.sound = sound;
                        step.dataset.step = i;

                        // Mark downbeats (1st beat of each bar)
                        if (i % 4 === 0) {
                            step.classList.add("downbeat");
                        }

                        if (sequencerData[sound][i]) {
                            step.classList.add("active");
                        }
                        step.addEventListener("click", () =>
                            toggleStep(sound, i, step),
                        );
                        row.appendChild(step);
                    }

                    sequencer.appendChild(row);
                });
            }

            // Initialize everything
            initializeSoundParams();
            soundSlots.forEach((slot) => {
                sequencerData[slot] = new Array(steps).fill(false);
            });
            renderPads();
            renderSequencer();

            // Initialize visualizer
            const visualizer = document.getElementById("visualizer");
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement("div");
                bar.className = "waveform-bar";
                bar.style.left = i * 10 + "px";
                bar.style.height = "0px";
                visualizer.appendChild(bar);
            }

            function toggleStep(sound, stepIndex, element) {
                sequencerData[sound][stepIndex] =
                    !sequencerData[sound][stepIndex];
                element.classList.toggle("active");
            }

            // Synthesize drum sounds (for slots 1-4)
            function createDrumSound(type) {
                const now = audioContext.currentTime;

                if (type === 'slot1') {
                    // KICK DRUM - Sine wave with pitch envelope
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();

                    osc.type = 'sine';

                    // Pitch envelope: Use drumParams
                    osc.frequency.setValueAtTime(drumParams.kick.startFreq, now);
                    osc.frequency.exponentialRampToValueAtTime(drumParams.kick.endFreq, now + 0.05);

                    // Amp envelope: Exponential decay
                    gain.gain.setValueAtTime(0.5, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + drumParams.kick.decay);

                    osc.connect(gain);
                    gain.connect(audioContext.destination);

                    osc.start(now);
                    osc.stop(now + drumParams.kick.decay);

                } else if (type === 'slot2') {
                    // SNARE - Tonal body + white noise

                    // Tonal body
                    const bodyOsc = audioContext.createOscillator();
                    const bodyGain = audioContext.createGain();
                    bodyOsc.type = 'triangle';
                    bodyOsc.frequency.value = drumParams.snare.toneFreq;

                    bodyGain.gain.setValueAtTime(0.3, now);
                    bodyGain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);

                    bodyOsc.connect(bodyGain);
                    bodyGain.connect(audioContext.destination);

                    // White noise layer
                    const bufferSize = audioContext.sampleRate * 0.2;
                    const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                    const noiseData = noiseBuffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) {
                        noiseData[i] = Math.random() * 2 - 1;
                    }

                    const noiseSource = audioContext.createBufferSource();
                    const noiseGain = audioContext.createGain();
                    const noiseFilter = audioContext.createBiquadFilter();

                    noiseFilter.type = 'highpass';
                    noiseFilter.frequency.value = drumParams.snare.noiseCutoff;

                    noiseSource.buffer = noiseBuffer;
                    noiseGain.gain.setValueAtTime(0.3, now);
                    noiseGain.gain.exponentialRampToValueAtTime(0.01, now + drumParams.snare.decay);

                    noiseSource.connect(noiseFilter);
                    noiseFilter.connect(noiseGain);
                    noiseGain.connect(audioContext.destination);

                    bodyOsc.start(now);
                    bodyOsc.stop(now + 0.1);
                    noiseSource.start(now);

                } else if (type === 'slot3') {
                    // HI-HAT - High-passed white noise
                    const bufferSize = audioContext.sampleRate * 0.1;
                    const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                    const noiseData = noiseBuffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) {
                        noiseData[i] = Math.random() * 2 - 1;
                    }

                    const noiseSource = audioContext.createBufferSource();
                    const noiseGain = audioContext.createGain();
                    const noiseFilter = audioContext.createBiquadFilter();

                    noiseFilter.type = 'highpass';
                    noiseFilter.frequency.value = drumParams.hihat.cutoffFreq;
                    noiseFilter.Q.value = 1;

                    noiseSource.buffer = noiseBuffer;
                    noiseGain.gain.setValueAtTime(0.3, now);
                    noiseGain.gain.exponentialRampToValueAtTime(0.01, now + drumParams.hihat.decay);

                    noiseSource.connect(noiseFilter);
                    noiseFilter.connect(noiseGain);
                    noiseGain.connect(audioContext.destination);

                    noiseSource.start(now);

                } else if (type === 'slot4') {
                    // CYMBAL - Metallic noise with band-pass filter and LFO
                    const bufferSize = audioContext.sampleRate * drumParams.cymbal.decay;
                    const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                    const noiseData = noiseBuffer.getChannelData(0);

                    // Create metallic texture with square wave clusters
                    for (let i = 0; i < bufferSize; i++) {
                        let sample = 0;
                        // Mix several square waves at dissonant frequencies
                        sample += Math.sign(Math.sin(i * 0.13)) * 0.2;
                        sample += Math.sign(Math.sin(i * 0.17)) * 0.15;
                        sample += Math.sign(Math.sin(i * 0.23)) * 0.15;
                        sample += (Math.random() * 2 - 1) * 0.5; // Add some noise
                        noiseData[i] = sample;
                    }

                    const noiseSource = audioContext.createBufferSource();
                    const noiseGain = audioContext.createGain();
                    const bandpassFilter = audioContext.createBiquadFilter();

                    bandpassFilter.type = 'bandpass';
                    bandpassFilter.frequency.value = drumParams.cymbal.centerFreq;
                    bandpassFilter.Q.value = 1.5;

                    noiseSource.buffer = noiseBuffer;

                    // Slow attack and long decay
                    noiseGain.gain.setValueAtTime(0, now);
                    noiseGain.gain.linearRampToValueAtTime(0.25, now + 0.02);
                    noiseGain.gain.exponentialRampToValueAtTime(0.01, now + drumParams.cymbal.decay);

                    // Add LFO for wobble effect
                    const lfo = audioContext.createOscillator();
                    const lfoGain = audioContext.createGain();
                    lfo.frequency.value = drumParams.cymbal.lfoRate;
                    lfoGain.gain.value = 0.03;

                    lfo.connect(lfoGain);
                    lfoGain.connect(noiseGain.gain);

                    noiseSource.connect(bandpassFilter);
                    bandpassFilter.connect(noiseGain);
                    noiseGain.connect(audioContext.destination);

                    noiseSource.start(now);
                    lfo.start(now);
                    lfo.stop(now + drumParams.cymbal.decay);
                }

                updateVisualizer();
            }

            // Synthesize bird sounds (for slots 5-12)
            function createBirdSound(type) {
                const now = audioContext.currentTime;

                const p = soundParams[type];
                if (!p) return;

                // Oscillator for main sound
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                // LFO for vibrato/modulation
                const lfo = audioContext.createOscillator();
                const lfoGain = audioContext.createGain();

                lfo.frequency.value = p.modFreq;
                lfoGain.gain.value = p.modDepth;

                if (p.modFreq > 0) {
                    lfo.connect(lfoGain);
                    lfoGain.connect(oscillator.frequency);
                }

                oscillator.type = p.type;
                oscillator.frequency.value = p.freq;

                // Special behaviors
                if (p.sweep) {
                    // Rooster crow sweeps up then down
                    oscillator.frequency.setValueAtTime(p.freq * 0.8, now);
                    oscillator.frequency.linearRampToValueAtTime(
                        p.freq * 1.5,
                        now + 0.2,
                    );
                    oscillator.frequency.linearRampToValueAtTime(
                        p.freq * 0.9,
                        now + p.duration,
                    );
                }

                if (p.laugh) {
                    // Kookaburra laugh - rhythmic amplitude modulation
                    const laughLfo = audioContext.createOscillator();
                    const laughGain = audioContext.createGain();
                    laughLfo.frequency.value = 8; // Rhythm of laugh
                    laughGain.gain.value = 0.15;
                    laughLfo.connect(laughGain);
                    laughGain.connect(gainNode.gain);
                    laughLfo.start(now);
                    laughLfo.stop(now + p.duration);
                }

                if (p.honk) {
                    // Goose honk - frequency dip
                    oscillator.frequency.setValueAtTime(p.freq, now);
                    oscillator.frequency.exponentialRampToValueAtTime(
                        p.freq * 0.7,
                        now + 0.1,
                    );
                    oscillator.frequency.exponentialRampToValueAtTime(
                        p.freq,
                        now + p.duration,
                    );
                }

                // Envelope - different attack/decay for different birds
                const attackTime = p.noisy ? 0.005 : 0.01;
                const peakGain = p.harsh ? 0.25 : 0.3;

                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(
                    peakGain,
                    now + attackTime,
                );

                if (p.noisy) {
                    // Quick staccato decay for cluck
                    gainNode.gain.exponentialRampToValueAtTime(
                        0.01,
                        now + p.duration * 0.3,
                    );
                    gainNode.gain.setValueAtTime(0.01, now + p.duration);
                } else {
                    gainNode.gain.exponentialRampToValueAtTime(
                        0.01,
                        now + p.duration,
                    );
                }

                // Optional noise layer for harsh sounds (crows, ravens)
                if (p.harsh || p.noisy) {
                    const bufferSize = audioContext.sampleRate * p.duration;
                    const noiseBuffer = audioContext.createBuffer(
                        1,
                        bufferSize,
                        audioContext.sampleRate,
                    );
                    const noiseData = noiseBuffer.getChannelData(0);

                    for (let i = 0; i < bufferSize; i++) {
                        noiseData[i] = (Math.random() * 2 - 1) * 0.1;
                    }

                    const noiseSource = audioContext.createBufferSource();
                    const noiseGain = audioContext.createGain();
                    const noiseFilter = audioContext.createBiquadFilter();

                    noiseFilter.type = "bandpass";
                    noiseFilter.frequency.value = p.freq;
                    noiseFilter.Q.value = 1;

                    noiseSource.buffer = noiseBuffer;
                    noiseGain.gain.setValueAtTime(p.harsh ? 0.15 : 0.08, now);
                    noiseGain.gain.exponentialRampToValueAtTime(
                        0.01,
                        now + p.duration,
                    );

                    noiseSource.connect(noiseFilter);
                    noiseFilter.connect(noiseGain);
                    noiseGain.connect(audioContext.destination);

                    noiseSource.start(now);
                    noiseSource.stop(now + p.duration);
                }

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.start(now);
                lfo.start(now);
                oscillator.stop(now + p.duration);
                lfo.stop(now + p.duration);

                // Update visualizer
                updateVisualizer();
            }

            function updateVisualizer() {
                const bars = visualizer.querySelectorAll(".waveform-bar");
                bars.forEach((bar, i) => {
                    const height = Math.random() * 40;
                    bar.style.height = height + "px";
                    setTimeout(() => {
                        bar.style.height = "0px";
                    }, 100);
                });
            }

            function playSound(soundType) {
                // First 4 slots are drums, rest are birds
                if (['slot1', 'slot2', 'slot3', 'slot4'].includes(soundType)) {
                    createDrumSound(soundType);
                } else {
                    createBirdSound(soundType);
                }

                // Visual feedback on pad
                const pad = document.querySelector(
                    `[data-sound="${soundType}"]`,
                );
                if (pad) {
                    pad.classList.add("playing");
                    setTimeout(() => pad.classList.remove("playing"), 100);
                }
            }

            // Create reverb impulse response
            function createReverbImpulse() {
                const length = audioContext.sampleRate * 2; // 2 second reverb
                const impulse = audioContext.createBuffer(2, length, audioContext.sampleRate);
                const left = impulse.getChannelData(0);
                const right = impulse.getChannelData(1);

                for (let i = 0; i < length; i++) {
                    const decay = Math.exp(-i / (audioContext.sampleRate * 0.5));
                    left[i] = (Math.random() * 2 - 1) * decay;
                    right[i] = (Math.random() * 2 - 1) * decay;
                }

                return impulse;
            }

            // Create distortion curve
            function createDistortionCurve(amount = 50) {
                const samples = 44100;
                const curve = new Float32Array(samples);
                const deg = Math.PI / 180;

                for (let i = 0; i < samples; i++) {
                    const x = (i * 2) / samples - 1;
                    curve[i] = ((3 + amount) * x * 20 * deg) / (Math.PI + amount * Math.abs(x));
                }

                return curve;
            }

            // Initialize reverb
            function initReverb() {
                if (!reverbNode) {
                    reverbNode = audioContext.createConvolver();
                    reverbNode.buffer = createReverbImpulse();
                    reverbNode.connect(audioContext.destination);
                }
            }

            // Randomize synth parameters
            function randomizeSynth() {
                const waveforms = ["sine", "sine", "sine", "triangle"]; // Mostly sine waves
                synthParams = {
                    waveform:
                        waveforms[Math.floor(Math.random() * waveforms.length)],
                    brightness: Math.random() * 0.3, // 0-0.3
                    harmonics: Math.random() * 0.4, // 0-0.4
                    attack: 0.01,
                    decay: 0.1,
                    sustain: 0.8,
                    release: 0.3,
                };

                document.getElementById("status-text").textContent =
                    "üé≤ Synth randomized!";
                setTimeout(() => {
                    document.getElementById("status-text").textContent =
                        "KEYBOARD MODE - FL Studio layout: QWERTY row (C5-G6), ZXCVBNM row (C4-E5)";
                }, 1500);
            }

            // Play synth note
            function playSynthNote(note, duration = null) {
                const baseFreq = noteFrequencies[note];
                if (!baseFreq) return;

                // Apply octave shift
                const freq = baseFreq * Math.pow(2, currentOctave);
                const now = audioContext.currentTime;

                // Main oscillator - simple sine wave
                const osc = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                osc.type = synthParams.waveform;
                osc.frequency.value = freq;

                // Add subtle harmonics for character
                let harmOsc = null;
                let harmGain = null;
                if (synthParams.harmonics > 0.05) {
                    harmOsc = audioContext.createOscillator();
                    harmGain = audioContext.createGain();
                    harmOsc.frequency.value = freq * 2; // Perfect octave harmonic
                    harmOsc.type = "sine";
                    harmGain.gain.value = synthParams.harmonics * 0.2;
                    harmOsc.connect(harmGain);
                    harmGain.connect(audioContext.destination);
                }

                // Optional brightness (high-pass filtered tone)
                let brightOsc = null;
                let brightGain = null;
                let brightFilter = null;
                if (synthParams.brightness > 0.05) {
                    brightOsc = audioContext.createOscillator();
                    brightGain = audioContext.createGain();
                    brightFilter = audioContext.createBiquadFilter();

                    brightFilter.type = "highpass";
                    brightFilter.frequency.value = freq * 2;
                    brightFilter.Q.value = 0.5;

                    brightOsc.type = "sine";
                    brightOsc.frequency.value = freq * 3;
                    brightGain.gain.value = synthParams.brightness * 0.15;

                    brightOsc.connect(brightFilter);
                    brightFilter.connect(brightGain);
                    brightGain.connect(audioContext.destination);
                }

                // Envelope
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(
                    0.25,
                    now + synthParams.attack,
                );

                if (duration) {
                    // Note with fixed duration
                    gainNode.gain.linearRampToValueAtTime(
                        0.25 * synthParams.sustain,
                        now + synthParams.attack + synthParams.decay,
                    );
                    gainNode.gain.exponentialRampToValueAtTime(
                        0.01,
                        now + duration,
                    );
                } else {
                    // Sustained note (for key hold)
                    gainNode.gain.linearRampToValueAtTime(
                        0.25 * synthParams.sustain,
                        now + synthParams.attack + synthParams.decay,
                    );
                }

                // Connect nodes with optional angry bird effects
                let finalDestination = audioContext.destination;
                let distortion = null;
                let dryGain = null;
                let wetGain = null;

                if (angryBirdAmount > 0) {
                    // Initialize reverb if needed
                    initReverb();

                    // Create distortion
                    distortion = audioContext.createWaveShaper();
                    distortion.curve = createDistortionCurve(angryBirdAmount);
                    distortion.oversample = '4x';

                    // Create dry/wet mix for reverb
                    // More reverb as distortion increases
                    const reverbMix = Math.min(angryBirdAmount / 400, 0.5); // 0 to 50% wet
                    dryGain = audioContext.createGain();
                    wetGain = audioContext.createGain();
                    dryGain.gain.value = 1 - reverbMix;
                    wetGain.gain.value = reverbMix;

                    // Route through distortion then split to dry/wet
                    gainNode.connect(distortion);
                    distortion.connect(dryGain);
                    distortion.connect(wetGain);

                    dryGain.connect(audioContext.destination);
                    wetGain.connect(reverbNode);

                    // Connect harmonics through distortion too
                    if (harmGain) {
                        harmGain.disconnect();
                        harmGain.connect(distortion);
                    }
                    if (brightGain) {
                        brightGain.disconnect();
                        brightGain.connect(distortion);
                    }
                } else {
                    // Normal routing (no effects)
                    gainNode.connect(audioContext.destination);
                }

                osc.start(now);
                if (harmOsc) harmOsc.start(now);
                if (brightOsc) brightOsc.start(now);

                if (duration) {
                    osc.stop(now + duration);
                    if (harmOsc) harmOsc.stop(now + duration);
                    if (brightOsc) brightOsc.stop(now + duration);
                } else {
                    // Return nodes for later stopping
                    return {
                        osc,
                        harmOsc,
                        brightOsc,
                        gainNode,
                        harmGain,
                        brightGain,
                        distortion,
                        dryGain,
                        wetGain,
                    };
                }
            }

            // Stop synth note
            function stopSynthNote(noteKey) {
                const nodes = activeNotes.get(noteKey);
                if (!nodes) return;

                const now = audioContext.currentTime;

                // Release envelope
                nodes.gainNode.gain.cancelScheduledValues(now);
                nodes.gainNode.gain.setValueAtTime(
                    nodes.gainNode.gain.value,
                    now,
                );
                nodes.gainNode.gain.exponentialRampToValueAtTime(
                    0.01,
                    now + synthParams.release,
                );

                if (nodes.harmGain) {
                    nodes.harmGain.gain.exponentialRampToValueAtTime(
                        0.01,
                        now + synthParams.release,
                    );
                }

                if (nodes.brightGain) {
                    nodes.brightGain.gain.exponentialRampToValueAtTime(
                        0.01,
                        now + synthParams.release,
                    );
                }

                // Stop oscillators
                nodes.osc.stop(now + synthParams.release);
                if (nodes.harmOsc)
                    nodes.harmOsc.stop(now + synthParams.release);
                if (nodes.brightOsc)
                    nodes.brightOsc.stop(now + synthParams.release);

                activeNotes.delete(noteKey);
            }

            // Keyboard controls
            document.addEventListener("keydown", (e) => {
                const key = e.key.toLowerCase();

                // Check if in keyboard mode
                if (isKeyboardMode) {
                    // Ignore gap keys (no note between B and C, E and F)
                    if (key === '8' || key === 'k' || key === '4') {
                        return; // Silent keys - musical gaps
                    }

                    // Find piano key
                    const pianoKey = Array.from(
                        document.querySelectorAll(".piano-key"),
                    ).find((pk) => pk.dataset.key === key);

                    if (pianoKey && !activeNotes.has(key)) {
                        const note = pianoKey.dataset.note;
                        const nodes = playSynthNote(note);
                        if (nodes) {
                            activeNotes.set(key, nodes);
                            pianoKey.classList.add("playing");
                        }
                        return;
                    }
                } else {
                    // Drum pad mode
                    const soundEntry = Object.entries(sounds).find(
                        ([_, data]) => data.key === key,
                    );
                    if (soundEntry) {
                        playSound(soundEntry[0]);
                    }
                }

                // Space to play/stop
                if (e.key === " ") {
                    e.preventDefault();
                    if (isPlaying) {
                        stopSequencer();
                    } else {
                        startSequencer();
                    }
                }
            });

            document.addEventListener("keyup", (e) => {
                const key = e.key.toLowerCase();

                if (isKeyboardMode && activeNotes.has(key)) {
                    stopSynthNote(key);

                    // Remove visual feedback
                    const pianoKey = Array.from(
                        document.querySelectorAll(".piano-key"),
                    ).find((pk) => pk.dataset.key === key);
                    if (pianoKey) {
                        pianoKey.classList.remove("playing");
                    }
                }
            });

            // Sequencer playback
            function startSequencer() {
                if (isPlaying) return;

                isPlaying = true;
                currentStep = 0;
                document.getElementById("play-btn").classList.add("active");
                document.getElementById("status-text").textContent =
                    "üéµ Playing...";

                const stepDuration = ((60 / bpm) * 1000) / 4; // 16th notes

                intervalId = setInterval(() => {
                    playStep(currentStep);
                    currentStep = (currentStep + 1) % steps;
                }, stepDuration);
            }

            function stopSequencer() {
                isPlaying = false;
                clearInterval(intervalId);
                currentStep = 0;
                document.getElementById("play-btn").classList.remove("active");
                document.getElementById("status-text").textContent =
                    "Ready to jam! Click pads or use keyboard (QWER/ASDF/ZXCV)";

                // Remove current step highlighting
                document
                    .querySelectorAll(".step.current")
                    .forEach((s) => s.classList.remove("current"));
                document.getElementById("step-counter").textContent =
                    "Step: 0/16";
            }

            function playStep(stepIndex) {
                // Remove previous current highlighting
                document
                    .querySelectorAll(".step.current")
                    .forEach((s) => s.classList.remove("current"));

                // Highlight current step
                document
                    .querySelectorAll(`[data-step="${stepIndex}"]`)
                    .forEach((s) => {
                        s.classList.add("current");
                    });

                // Play active sounds for this step
                Object.keys(sequencerData).forEach((sound) => {
                    if (sequencerData[sound][stepIndex]) {
                        playSound(sound);
                    }
                });

                document.getElementById("step-counter").textContent =
                    `Step: ${stepIndex + 1}/16`;
            }

            // Controls
            document
                .getElementById("play-btn")
                .addEventListener("click", startSequencer);
            document
                .getElementById("stop-btn")
                .addEventListener("click", stopSequencer);

            document
                .getElementById("clear-btn")
                .addEventListener("click", () => {
                    Object.keys(sequencerData).forEach((sound) => {
                        sequencerData[sound].fill(false);
                    });
                    document
                        .querySelectorAll(".step.active")
                        .forEach((s) => s.classList.remove("active"));
                });

            document
                .getElementById("random-btn")
                .addEventListener("click", () => {
                    generateRandomPattern();
                });

            document
                .getElementById("newbirds-btn")
                .addEventListener("click", () => {
                    generateNewBirds();
                });

            document
                .getElementById("keyboard-btn")
                .addEventListener("click", () => {
                    isKeyboardMode = !isKeyboardMode;
                    const synthPanel = document.getElementById("synth-panel");
                    const keyboardBtn = document.getElementById("keyboard-btn");

                    if (isKeyboardMode) {
                        synthPanel.classList.add("active");
                        keyboardBtn.classList.add("active");
                        document.getElementById("status-text").textContent =
                            "KEYBOARD MODE - FL Studio layout: QWERTY row (C5-G6), ZXCVBNM row (C4-E5)";
                    } else {
                        synthPanel.classList.remove("active");
                        keyboardBtn.classList.remove("active");
                        // Stop all active notes
                        activeNotes.forEach((nodes, key) => {
                            stopSynthNote(key);
                        });
                        document
                            .querySelectorAll(".piano-key.playing")
                            .forEach((k) => k.classList.remove("playing"));
                        document.getElementById("status-text").textContent =
                            "Ready to jam! Click pads or use keyboard (QWER/ASDF/ZXCV)";
                    }
                });

            document
                .getElementById("octave-up")
                .addEventListener("click", () => {
                    if (currentOctave < 2) {
                        currentOctave++;
                        document.getElementById("octave-display").textContent =
                            currentOctave > 0
                                ? `+${currentOctave}`
                                : currentOctave;
                    }
                });

            document
                .getElementById("octave-down")
                .addEventListener("click", () => {
                    if (currentOctave > -2) {
                        currentOctave--;
                        document.getElementById("octave-display").textContent =
                            currentOctave > 0
                                ? `+${currentOctave}`
                                : currentOctave;
                    }
                });

            document
                .getElementById("random-synth")
                .addEventListener("click", () => {
                    randomizeSynth();
                });

            // Angry Bird Knob handling
            const angryKnob = document.getElementById("angry-knob");
            const angryKnobValue = document.getElementById("angry-knob-value");
            let knobStartX = 0;
            let knobStartValue = 0;

            function updateAngryKnob(value) {
                // Clamp value between 0 and 400
                angryBirdAmount = Math.max(0, Math.min(400, value));

                // Update display
                angryKnobValue.textContent = Math.round(angryBirdAmount);

                // Calculate color (gray to red)
                const intensity = angryBirdAmount / 400;
                const r = Math.floor(128 + (127 * intensity)); // 128 to 255
                const g = Math.floor(128 * (1 - intensity));   // 128 to 0
                const b = Math.floor(128 * (1 - intensity));   // 128 to 0

                angryKnob.style.background = `radial-gradient(circle at 30% 30%, #ffffff, rgb(${r}, ${g}, ${b}))`;

                // Rotate indicator (0-270 degrees)
                const rotation = (angryBirdAmount / 400) * 270 - 135;
                const indicator = angryKnob.querySelector('.angry-knob-indicator');
                indicator.style.transform = `translateX(-50%) rotate(${rotation}deg)`;
                indicator.style.transformOrigin = 'center 25px';
            }

            angryKnob.addEventListener("mousedown", (e) => {
                isDraggingKnob = true;
                knobStartX = e.clientX;
                knobStartValue = angryBirdAmount;
                e.preventDefault();
            });

            document.addEventListener("mousemove", (e) => {
                if (isDraggingKnob) {
                    const deltaX = e.clientX - knobStartX;
                    const newValue = knobStartValue + deltaX;
                    updateAngryKnob(newValue);
                }
            });

            document.addEventListener("mouseup", () => {
                isDraggingKnob = false;
            });

            // Initialize knob
            updateAngryKnob(0);

            // Piano key click handlers
            document.querySelectorAll(".piano-key").forEach((key) => {
                key.addEventListener("mousedown", () => {
                    const note = key.dataset.note;
                    playSynthNote(note, 0.3); // Fixed duration for mouse clicks
                    key.classList.add("playing");
                    setTimeout(() => key.classList.remove("playing"), 300);
                });
            });

            function generateRandomPattern() {
                console.log("Generating random pattern...");

                // Clear existing pattern
                Object.keys(sequencerData).forEach((sound) => {
                    sequencerData[sound].fill(false);
                });
                document
                    .querySelectorAll(".step.active")
                    .forEach((s) => s.classList.remove("active"));

                // Classify sounds by frequency dynamically
                const lowFreq = [];
                const midFreq = [];
                const highFreq = [];

                soundSlots.forEach((slot) => {
                    // First 4 slots are drums with fixed classification
                    if (slot === 'slot1') {
                        lowFreq.push(slot); // Kick drum
                    } else if (slot === 'slot2') {
                        midFreq.push(slot); // Snare
                    } else if (slot === 'slot3' || slot === 'slot4') {
                        highFreq.push(slot); // Hi-hat and cymbal
                    } else {
                        // Slots 5-12 are birds, classify by frequency
                        if (soundParams[slot] && soundParams[slot].freq) {
                            const freq = soundParams[slot].freq;
                            if (freq < 400) {
                                lowFreq.push(slot);
                            } else if (freq < 1000) {
                                midFreq.push(slot);
                            } else {
                                highFreq.push(slot);
                            }
                        } else {
                            // Fallback to highFreq if no params
                            highFreq.push(slot);
                        }
                    }
                });

                console.log("lowFreq:", lowFreq);
                console.log("midFreq:", midFreq);
                console.log("highFreq:", highFreq);

                // Beat strength (1 = downbeat, 0.5 = offbeat, 0.25 = weak)
                const beatStrength = [
                    1,
                    0.25,
                    0.5,
                    0.25, // Steps 0-3
                    1,
                    0.25,
                    0.5,
                    0.25, // Steps 4-7
                    1,
                    0.25,
                    0.5,
                    0.25, // Steps 8-11
                    1,
                    0.25,
                    0.5,
                    0.25, // Steps 12-15
                ];

                // Generate pattern for each sound
                Object.keys(sequencerData).forEach((sound) => {
                    let baseProbability;
                    let beatPreference;

                    // Determine probability based on frequency range
                    if (lowFreq.includes(sound)) {
                        baseProbability = 0.12; // Sparse bass/kick-like
                        beatPreference = 2.5; // Strong preference for downbeats
                    } else if (midFreq.includes(sound)) {
                        baseProbability = 0.16; // Moderate density
                        beatPreference = 1.5; // Some preference for strong beats
                    } else if (highFreq.includes(sound)) {
                        baseProbability = 0.22; // More frequent
                        beatPreference = 0.8; // Can hit offbeats freely
                    } else {
                        // Default fallback (shouldn't happen)
                        baseProbability = 0.18;
                        beatPreference = 1.0;
                    }

                    // Generate pattern using weighted probability
                    for (let step = 0; step < steps; step++) {
                        const strength = beatStrength[step];
                        const adjustedProbability =
                            baseProbability *
                            (1 + (strength - 0.5) * beatPreference);

                        if (Math.random() < adjustedProbability) {
                            sequencerData[sound][step] = true;

                            // Update visual
                            const stepElement = document.querySelector(
                                `[data-sound="${sound}"][data-step="${step}"]`,
                            );
                            if (stepElement) {
                                stepElement.classList.add("active");
                            }
                        }
                    }

                    // Ensure at least one low-freq sound hits on beat 0 for groove
                    if (
                        lowFreq.includes(sound) &&
                        !sequencerData[sound].some((v) => v)
                    ) {
                        if (Math.random() < 0.4) {
                            const beatChoice = [0, 4, 8][
                                Math.floor(Math.random() * 3)
                            ];
                            sequencerData[sound][beatChoice] = true;
                            const stepElement = document.querySelector(
                                `[data-sound="${sound}"][data-step="${beatChoice}"]`,
                            );
                            if (stepElement) {
                                stepElement.classList.add("active");
                            }
                        }
                    }
                });

                console.log("Pattern generated, checking total notes...");
                let totalNotes = 0;
                Object.keys(sequencerData).forEach((sound) => {
                    const notesInSound = sequencerData[sound].filter(v => v).length;
                    if (notesInSound > 0) {
                        console.log(`  ${sound}: ${notesInSound} notes`);
                        totalNotes += notesInSound;
                    }
                });
                console.log(`Total notes placed: ${totalNotes}`);

                // Add some euclidean-distributed high-hats (using a random high freq sound)
                if (highFreq.length > 0) {
                    const hihatSound =
                        highFreq[Math.floor(Math.random() * highFreq.length)];
                    const numHits = Math.floor(Math.random() * 4) + 3; // 3-6 hits

                    // Clear previous
                    sequencerData[hihatSound].fill(false);
                    document
                        .querySelectorAll(`[data-sound="${hihatSound}"]`)
                        .forEach((s) => s.classList.remove("active"));

                    // Euclidean distribution
                    for (let i = 0; i < numHits; i++) {
                        const step = Math.floor((i * steps) / numHits);
                        sequencerData[hihatSound][step] = true;
                        const stepElement = document.querySelector(
                            `[data-sound="${hihatSound}"][data-step="${step}"]`,
                        );
                        if (stepElement) {
                            stepElement.classList.add("active");
                        }
                    }
                }

                console.log("Random pattern generation complete!");
            }

            document
                .getElementById("tempo-input")
                .addEventListener("change", (e) => {
                    bpm = parseInt(e.target.value);
                    if (isPlaying) {
                        stopSequencer();
                        startSequencer();
                    }
                });
        </script>
    </body>
</html>
